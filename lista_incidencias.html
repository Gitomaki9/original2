// lista_incidencias.js - VERSI√ìN COMPLETA Y FUNCIONAL
(function() {
    'use strict';
    
    // Funci√≥n helper para seleccionar elementos
    function $(id) {
        return document.getElementById(id);
    }
    
    // Funci√≥n para mostrar estado
    function setEstadoCarga(texto, tipo = 'info') {
        const elemento = $('estadoCarga');
        if (!elemento) return;
        
        elemento.textContent = texto;
        elemento.className = 'meta-pill';
        
        if (tipo === 'error') {
            elemento.classList.add('error');
            elemento.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> ${texto}`;
        } else if (tipo === 'success') {
            elemento.classList.add('ok');
            elemento.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${texto}`;
        } else {
            elemento.innerHTML = `<i class="fa-solid fa-circle-info"></i> ${texto}`;
        }
    }
    
    // Funci√≥n para formatear fecha
    function formatFecha(fechaISO) {
        if (!fechaISO) return '‚Äî';
        try {
            const fecha = new Date(fechaISO);
            if (isNaN(fecha.getTime())) return 'Fecha inv√°lida';
            return fecha.toLocaleDateString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch {
            return '‚Äî';
        }
    }
    
    // Funci√≥n para badge de estado
    function getBadgeEstado(estado) {
        const estadoLower = String(estado || '').toLowerCase();
        
        if (estadoLower.includes('pendiente') || estadoLower.includes('reporte')) {
            return `<span class="status-badge status-reporte">Reportado</span>`;
        }
        if (estadoLower.includes('proceso')) {
            return `<span class="status-badge status-proceso">En Proceso</span>`;
        }
        if (estadoLower.includes('solucionado')) {
            return `<span class="status-badge status-solucionado">Solucionado</span>`;
        }
        if (estadoLower.includes('cancelado')) {
            return `<span class="status-badge status-cancelado">Cancelado</span>`;
        }
        return `<span class="status-badge status-reporte">${estado || 'Pendiente'}</span>`;
    }
    
    // Inicializaci√≥n cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Iniciando aplicaci√≥n de incidencias');
        
        // Obtener cliente Supabase
        const supabase = window.supabaseClient || window.supabase;
        
        if (!supabase) {
            setEstadoCarga('Error: Supabase no configurado', 'error');
            console.error('‚ùå Supabase no est√° disponible en window');
            return;
        }
        
        console.log('‚úÖ Cliente Supabase disponible:', supabase);
        
        // Variables globales
        let usuarioActual = null;
        let esAdmin = false;
        let incidencias = [];
        
        // 1. Verificar sesi√≥n y permisos
        async function verificarSesionYPermisos() {
            try {
                console.log('üîê Verificando sesi√≥n...');
                
                // NOTA: Usar supabase.auth.getSession() correctamente
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.warn('Error obteniendo sesi√≥n:', error.message);
                    return { loggedIn: false, esAdmin: false, nombre: null };
                }
                
                if (session?.user) {
                    usuarioActual = session.user;
                    console.log('üë§ Usuario identificado:', usuarioActual.email);
                    
                    // Intentar obtener datos adicionales del usuario
                    try {
                        const { data: usuario, error: userError } = await supabase
                            .from('usuarios')
                            .select('nombre_completo, tipo_usuario')
                            .eq('id', usuarioActual.id)
                            .single();
                        
                        if (!userError && usuario) {
                            esAdmin = usuario.tipo_usuario === 'admin';
                            return { 
                                loggedIn: true, 
                                esAdmin, 
                                nombre: usuario.nombre_completo || usuarioActual.email 
                            };
                        }
                    } catch (dbError) {
                        console.warn('No se pudo obtener datos de usuario:', dbError.message);
                    }
                    
                    return { 
                        loggedIn: true, 
                        esAdmin: false, 
                        nombre: usuarioActual.email 
                    };
                }
                
                return { loggedIn: false, esAdmin: false, nombre: null };
                
            } catch (error) {
                console.error('‚ùå Error en verificarSesionYPermisos:', error);
                return { loggedIn: false, esAdmin: false, nombre: null };
            }
        }
        
        // 2. Cargar incidencias
        async function cargarIncidencias() {
            try {
                setEstadoCarga('Cargando incidencias...');
                
                // Construir consulta base
                let query = supabase
                    .from('denuncias')
                    .select('*')
                    .order('creado_en', { ascending: false });
                
                // Aplicar filtros
                const fechaInicio = $('fecha-inicio')?.value;
                const fechaFin = $('fecha-fin')?.value;
                const estado = $('estado')?.value;
                
                if (fechaInicio) {
                    query = query.gte('fecha_incidente', fechaInicio);
                }
                
                if (fechaFin) {
                    query = query.lte('fecha_incidente', fechaFin);
                }
                
                if (estado && estado !== 'todos') {
                    let estadoBD = estado;
                    if (estado === 'reporte') estadoBD = 'pendiente';
                    if (estado === 'proceso') estadoBD = 'en_proceso';
                    query = query.eq('estado', estadoBD);
                }
                
                // Aplicar filtros de usuario
                if (usuarioActual && !esAdmin) {
                    query = query.or(`user_id.eq.${usuarioActual.id},es_anonimo.eq.true`);
                } else if (!usuarioActual) {
                    query = query.eq('es_anonimo', true);
                }
                
                // Ejecutar consulta
                console.log('üìä Ejecutando consulta...');
                const { data, error } = await query;
                
                if (error) {
                    console.error('Error en consulta:', error);
                    throw new Error(`Error de base de datos: ${error.message}`);
                }
                
                incidencias = data || [];
                mostrarIncidencias(incidencias);
                
                const totalElement = $('totalInc');
                if (totalElement) {
                    totalElement.textContent = incidencias.length;
                }
                
                setEstadoCarga(`Cargadas ${incidencias.length} incidencias`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error cargando incidencias:', error);
                setEstadoCarga(`Error: ${error.message}`, 'error');
                mostrarIncidencias([]);
            }
        }
        
        // 3. Mostrar incidencias en tabla
        function mostrarIncidencias(data) {
            const tbody = $('tbodyInc');
            if (!tbody) return;
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fa-solid fa-inbox"></i><br>
                            No se encontraron incidencias
                        </td>
                    </tr>
                `;
                return;
            }
            
            const filasHTML = data.map(inc => {
                return `
                    <tr>
                        <td><strong>#${inc.id}</strong></td>
                        <td>${formatFecha(inc.fecha_incidente)}</td>
                        <td>${inc.tipo_formulario === 'reporte' ? 'Reporte' : 'Denuncia'}</td>
                        <td>${inc.categoria || '‚Äî'}</td>
                        <td>${inc.titulo || '‚Äî'}</td>
                        <td>${inc.distrito || inc.ubicacion || '‚Äî'}</td>
                        <td>${getBadgeEstado(inc.estado)}</td>
                        <td>
                            <button class="link-btn btn-detalle" data-id="${inc.id}">
                                <i class="fa-solid fa-eye"></i> Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = filasHTML;
            
            // Agregar eventos a botones de detalle
            tbody.querySelectorAll('.btn-detalle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const incidencia = data.find(i => i.id == id);
                    if (incidencia) {
                        mostrarDetalleModal(incidencia);
                    }
                });
            });
        }
        
        // 4. Mostrar detalle en modal
        function mostrarDetalleModal(inc) {
            const modal = $('modalDetalle');
            const title = $('modalTitle');
            const body = $('modalBody');
            
            if (!modal || !title || !body) return;
            
            title.textContent = `Detalle: ${inc.titulo || 'Incidencia'}`;
            
            const fechaIncidente = formatFecha(inc.fecha_incidente);
            const fechaCreacion = new Date(inc.creado_en).toLocaleString('es-PE');
            
            let contenido = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <h4 style="color: #8b0000; margin-bottom: 10px;">Informaci√≥n B√°sica</h4>
                        <p><strong>ID:</strong> ${inc.id}</p>
                        <p><strong>Tipo:</strong> ${inc.tipo_formulario === 'reporte' ? 'Reporte' : 'Denuncia'}</p>
                        <p><strong>Estado:</strong> ${getBadgeEstado(inc.estado)}</p>
                        <p><strong>Fecha Incidente:</strong> ${fechaIncidente}</p>
                        <p><strong>Fecha Reporte:</strong> ${fechaCreacion}</p>
                    </div>
                    
                    <div>
                        <h4 style="color: #8b0000; margin-bottom: 10px;">Descripci√≥n</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <p style="margin: 0; white-space: pre-wrap;">${inc.descripcion || 'Sin descripci√≥n'}</p>
                        </div>
                    </div>
            `;
            
            if (inc.placa_vehiculo) {
                contenido += `
                    <div>
                        <h4 style="color: #8b0000; margin-bottom: 10px;">Veh√≠culo</h4>
                        <p><strong>Placa:</strong> ${inc.placa_vehiculo}</p>
                    </div>
                `;
            }
            
            if (esAdmin) {
                contenido += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <h4 style="color: #8b0000; margin-bottom: 10px;">Informaci√≥n del Sistema</h4>
                        <p><strong>Usuario ID:</strong> ${inc.user_id || 'An√≥nimo'}</p>
                        <p><strong>Email:</strong> ${inc.usuario_email || 'No especificado'}</p>
                    </div>
                `;
            }
            
            contenido += `</div>`;
            body.innerHTML = contenido;
            modal.style.display = 'flex';
        }
        
        // 5. Configurar eventos
        function configurarEventos() {
            // Bot√≥n buscar
            const btnBuscar = $('btnBuscar');
            if (btnBuscar) {
                btnBuscar.addEventListener('click', cargarIncidencias);
            }
            
            // Bot√≥n buscar por t√©rmino
            const btnBuscarTermino = $('btnBuscarTermino');
            if (btnBuscarTermino) {
                btnBuscarTermino.addEventListener('click', async function() {
                    const termino = $('busqueda')?.value?.trim();
                    if (!termino) {
                        return cargarIncidencias();
                    }
                    
                    setEstadoCarga('Buscando...');
                    
                    try {
                        let query = supabase
                            .from('denuncias')
                            .select('*')
                            .or(`placa_vehiculo.ilike.%${termino}%,titulo.ilike.%${termino}%,id::text.ilike.%${termino}%`)
                            .order('creado_en', { ascending: false });
                        
                        const { data, error } = await query;
                        
                        if (error) throw error;
                        
                        incidencias = data || [];
                        mostrarIncidencias(incidencias);
                        setEstadoCarga(`Encontradas ${incidencias.length} incidencias`, 'success');
                        
                    } catch (error) {
                        console.error('Error en b√∫squeda:', error);
                        setEstadoCarga('Error en b√∫squeda', 'error');
                    }
                });
            }
            
            // Bot√≥n limpiar
            const btnLimpiar = $('btnLimpiar');
            if (btnLimpiar) {
                btnLimpiar.addEventListener('click', function() {
                    if ($('fecha-inicio')) $('fecha-inicio').value = '';
                    if ($('fecha-fin')) $('fecha-fin').value = '';
                    if ($('estado')) $('estado').value = 'todos';
                    if ($('busqueda')) $('busqueda').value = '';
                    setEstadoCarga('Filtros limpiados');
                    cargarIncidencias();
                });
            }
            
            // Logout
            const logoutBtn = $('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                        try {
                            await supabase.auth.signOut();
                            window.location.href = 'index.html';
                        } catch (error) {
                            console.error('Error al cerrar sesi√≥n:', error);
                            window.location.href = 'index.html';
                        }
                    }
                });
            }
            
            // Modal
            const modalClose = $('modalClose');
            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    $('modalDetalle').style.display = 'none';
                });
            }
            
            const modal = $('modalDetalle');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Enter en b√∫squeda
            const busquedaInput = $('busqueda');
            if (busquedaInput) {
                busquedaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        $('btnBuscarTermino')?.click();
                    }
                });
            }
        }
        
        // 6. Actualizar UI con datos de sesi√≥n
        async function actualizarUI() {
            const sesion = await verificarSesionYPermisos();
            
            // Actualizar barra lateral
            const nombreEl = $('nombreUsuario');
            const rolEl = $('rolUsuario');
            
            if (sesion.loggedIn) {
                if (nombreEl) nombreEl.textContent = sesion.nombre || 'Usuario';
                if (rolEl) rolEl.textContent = sesion.esAdmin ? 'Administrador' : 'Ciudadano';
                console.log(`üë§ Mostrando como: ${sesion.nombre} (${sesion.esAdmin ? 'Admin' : 'Ciudadano'})`);
            } else {
                if (nombreEl) nombreEl.textContent = 'Invitado';
                if (rolEl) rolEl.textContent = '‚Äî';
                console.log('üë§ Modo an√≥nimo activado');
            }
        }
        
        // 7. Inicializar aplicaci√≥n
        async function iniciar() {
            console.log('üîÑ Inicializando aplicaci√≥n...');
            
            // Actualizar UI
            await actualizarUI();
            
            // Configurar eventos
            configurarEventos();
            
            // Cargar incidencias iniciales
            await cargarIncidencias();
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
        }
        
        // Iniciar todo
        await iniciar();
        
    }); // Fin del DOMContentLoaded
    
})(); // Fin de la IIFE
