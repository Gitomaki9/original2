<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar Denuncia - Cusco Reporta</title>
  
  <!-- Fuentes y estilos -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- CARGAR SUPABASE EN EL HEAD (IMPORTANTE) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Guardar la biblioteca globalmente
    window.supabaseLib = window.supabase;
  </script>
  
  <style>
    /* ESTILOS GENERALES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at top, #7b0000 0%, #3b0000 60%, #1c0000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* TOPBAR MEJORADA */
    .topbar {
      background: white;
      padding: 0 30px;
      height: 70px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .topbar__logo img {
      height: 45px;
      width: auto;
      object-fit: contain;
    }
    
    .topbar__menu {
      display: flex;
      gap: 25px;
      align-items: center;
    }
    
    .topbar__menu a {
      text-decoration: none;
      color: #333;
      font-weight: 600;
      font-size: 0.95rem;
      padding: 8px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .topbar__menu a:hover {
      background: #f8f9fa;
      color: #8b0000;
      transform: translateY(-2px);
    }
    
    .topbar__menu a:last-child {
      background: linear-gradient(135deg, #8b0000, #b22222);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.25);
    }
    
    .topbar__menu a:last-child:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(139, 0, 0, 0.35);
    }
    
    /* CONTENEDOR PRINCIPAL */
    .container {
      display: flex;
      gap: 30px;
      padding: 30px;
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    
    /* SIDEBAR MEJORADA */
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: fit-content;
      position: sticky;
      top: 100px;
    }
    
    .sidebar__user {
      display: flex;
      align-items: center;
      gap: 15px;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .sidebar__avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #8b0000, #b22222);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
    }
    
    .sidebar__info h3 {
      margin: 0;
      color: #333;
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    .sidebar__info p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .sidebar__menu {
      list-style: none;
      margin: 0;
      padding: 0;
      flex: 1;
    }
    
    .sidebar__menu li {
      margin-bottom: 8px;
    }
    
    .sidebar__menu a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      text-decoration: none;
      color: #555;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .sidebar__menu a i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }
    
    .sidebar__menu a:hover {
      background: #f8f9fa;
      color: #8b0000;
      transform: translateX(5px);
    }
    
    .sidebar__menu a.active {
      background: linear-gradient(135deg, #8b0000, #b22222);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2);
    }
    
    .logout-btn {
      margin-top: auto;
      padding: 14px;
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: "Poppins", sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.35);
    }
    
    /* CONTENIDO PRINCIPAL MEJORADO */
    .main-content {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 35px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .main-content h1 {
      color: #8b0000;
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .main-content h1 i {
      font-size: 2rem;
    }
    
    .main-content > p {
      color: #666;
      font-size: 1rem;
      margin-bottom: 35px;
      font-weight: 500;
    }
    
    /* FORMULARIO MEJORADO */
    .fila {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
    }
    
    .columna {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .campo {
      display: flex;
      flex-direction: column;
    }
    
    .campo label {
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .campo label i {
      color: #8b0000;
      font-size: 1.1rem;
    }
    
    .campo input,
    .campo select,
    .campo textarea {
      padding: 14px 16px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-family: "Poppins", sans-serif;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .campo input:focus,
    .campo select:focus,
    .campo textarea:focus {
      outline: none;
      border-color: #8b0000;
      background: white;
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    }
    
    .campo textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    /* MAPA MEJORADO */
    #mapContainer {
      height: 320px;
      width: 100%;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    /* BOTONES MEJORADOS */
    .btn-principal,
    .btn-secundario {
      padding: 15px 25px;
      border-radius: 12px;
      font-family: "Poppins", sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-principal {
      background: linear-gradient(135deg, #8b0000, #b22222);
      color: white;
      box-shadow: 0 6px 15px rgba(139, 0, 0, 0.25);
    }
    
    .btn-principal:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(139, 0, 0, 0.3);
    }
    
    .btn-principal:active {
      transform: translateY(-1px);
    }
    
    .btn-secundario {
      background: #f8f9fa;
      color: #333;
      border: 2px solid #e9ecef;
    }
    
    .btn-secundario:hover {
      background: #e9ecef;
      transform: translateY(-2px);
      border-color: #8b0000;
      color: #8b0000;
    }
    
    /* INFORMACI√ìN ADICIONAL */
    .info-adicional {
      margin-top: 40px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border-left: 5px solid #8b0000;
    }
    
    .info-adicional h3 {
      color: #8b0000;
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-adicional ul {
      list-style: none;
      padding-left: 0;
    }
    
    .info-adicional li {
      color: #555;
      margin-bottom: 10px;
      padding-left: 25px;
      position: relative;
      font-weight: 500;
    }
    
    .info-adicional li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }
    
    /* MODALES MEJORADOS */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      position: relative;
    }
    
    .modal-content h3 {
      color: #8b0000;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.5rem;
      color: #666;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .close-modal:hover {
      color: #8b0000;
    }
    
    .modal-content input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-family: "Poppins", sans-serif;
      font-size: 1rem;
    }
    
    /* MENSAJES FLOTANTES */
    .mensaje-flotante {
      position: fixed;
      top: 30px;
      right: 30px;
      padding: 18px 28px;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      z-index: 9999;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.4s ease-out;
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 400px;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    .exito { 
      background: linear-gradient(135deg, #28a745, #20c997);
      border-left: 5px solid #1e7e34;
    }
    
    .error { 
      background: linear-gradient(135deg, #dc3545, #c82333);
      border-left: 5px solid #bd2130;
    }
    
    .info { 
      background: linear-gradient(135deg, #17a2b8, #138496);
      border-left: 5px solid #117a8b;
    }
    
    .warning { 
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border-left: 5px solid #d39e00;
      color: #333;
    }
    
    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        position: static;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
      }
      
      .sidebar__user {
        border-bottom: none;
        margin-bottom: 0;
        margin-right: 30px;
      }
      
      .sidebar__menu {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .sidebar__menu li {
        margin-bottom: 0;
      }
      
      .logout-btn {
        margin-top: 0;
      }
    }
    
    @media (max-width: 768px) {
      .topbar {
        padding: 0 20px;
        height: 60px;
      }
      
      .topbar__logo img {
        height: 40px;
      }
      
      .topbar__menu {
        gap: 15px;
      }
      
      .topbar__menu a {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      
      .container {
        padding: 20px;
      }
      
      .main-content {
        padding: 25px;
      }
      
      .main-content h1 {
        font-size: 1.8rem;
      }
      
      .columna {
        min-width: 100%;
      }
      
      .mensaje-flotante {
        top: 20px;
        right: 20px;
        left: 20px;
        max-width: none;
      }
    }
    
    @media (max-width: 480px) {
      .topbar__menu {
        gap: 10px;
      }
      
      .topbar__menu a {
        padding: 5px 10px;
        font-size: 0.8rem;
      }
      
      .main-content {
        padding: 20px;
      }
      
      .main-content h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR SUPERIOR MEJORADA -->
  <header class="topbar">
    <div class="topbar__logo">
      <img src="assents/images/CuscoReporta.png" alt="Cusco Reporta Logo">
    </div>
    <nav class="topbar__menu">
      <a href="index.html">Inicio</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="ayuda.html">Ayuda</a>
      <a href="consultas.html">Ver Denuncias</a>
    </nav>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container">
    <!-- SIDEBAR MEJORADA -->
    <aside class="sidebar">
      <div class="sidebar__user">
        <div class="sidebar__avatar"><i class="fa-solid fa-user"></i></div>
        <div class="sidebar__info">
          <h3>Jose P√©rez</h3>
          <p>Ciudadano</p>
        </div>
      </div>

      <ul class="sidebar__menu">
        <li>
          <a href="perfil_usuario.html">
            <i class="fa-solid fa-id-card"></i>
            <span>Ver perfil</span>
          </a>
        </li>
        <li>
          <a href="ReportarIncidencia.html">
            <i class="fa-solid fa-pen-to-square"></i>
            <span>Reportar</span>
          </a>
        </li>
        <li>
          <a href="registrar_Denuncia.html" class="active">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Denunciar</span>
          </a>
        </li>
        <li>
          <a href="lista_incidencias.html">
            <i class="fa-solid fa-list-check"></i>
            <span>Estado de reportes</span>
          </a>
        </li>
        <li>
          <a href="MapaIncidiencias(Ciudadano).html">
            <i class="fa-solid fa-map-location-dot"></i>
            <span>Mapa de incidencias</span>
          </a>
        </li>
        <li>
          <a href="notificaciones.html">
            <i class="fa-solid fa-bell"></i>
            <span>Notificaciones</span>
          </a>
        </li>
      </ul>

      <button class="logout-btn" id="logoutBtn">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n
      </button>
    </aside>

    <!-- CONTENIDO PRINCIPAL MEJORADO -->
    <main class="main-content">
      <h1><i class="fa-solid fa-triangle-exclamation"></i> Registrar Denuncia</h1>
      <p>Completa el formulario para reportar una incidencia de tr√°nsito.</p>
      
      <form id="formDenuncia" class="formulario">
        <div class="fila">
          <!-- IZQUIERDA -->
          <div class="columna">
            <div class="campo">
              <label for="fecha"><i class="fa-solid fa-calendar"></i> Fecha *</label>
              <input type="date" id="fecha" required>
            </div>
            
            <div class="campo">
              <label for="departamento"><i class="fa-solid fa-location-dot"></i> Departamento *</label>
              <select id="departamento" required>
                <option value="">Seleccione</option>
                <option value="Cusco" selected>Cusco</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="provincia">Provincia *</label>
              <select id="provincia" required>
                <option value="">Seleccione</option>
                <option value="Cusco" selected>Cusco</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="distrito">Distrito *</label>
              <select id="distrito" required>
                <option value="">Seleccione</option>
                <option value="Cusco">Cusco</option>
                <option value="San Sebasti√°n">San Sebasti√°n</option>
                <option value="San Jer√≥nimo">San Jer√≥nimo</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="referencia"><i class="fa-solid fa-map-pin"></i> Referencia *</label>
              <input type="text" id="referencia" placeholder="Ej: Av. El Sol frente al mercado" required>
            </div>

            <!-- Tipo de incidente -->
            <div class="campo">
              <label for="tipo_incidente"><i class="fa-solid fa-car-burst"></i> Tipo de incidente *</label>
              <select id="tipo_incidente" required>
                <option value="">Seleccione</option>
                <option value="Accidente">Accidente</option>
                <option value="Choque">Choque</option>
                <option value="Mal estacionamiento">Mal estacionamiento</option>
                <option value="Robo">Robo</option>
                <option value="Exceso de velocidad">Exceso de velocidad</option>
                <option value="Bache o hueco">Bache o hueco</option>
                <option value="Sem√°foro da√±ado">Sem√°foro da√±ado</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <!-- DERECHA: DATOS Y MAPA -->
          <div class="columna">
            <div class="campo">
              <label><i class="fa-solid fa-map"></i> Ubicar en el mapa (opcional)</label>
              <div id="mapContainer"></div>
              <p style="font-size: 0.9rem; color: #666; margin-top: 8px;">
                Haz clic en el mapa para seleccionar la ubicaci√≥n exacta
              </p>
            </div>
            
            <!-- Descripci√≥n de los hechos -->
            <div class="campo">
              <label for="hechos"><i class="fa-solid fa-file-lines"></i> Descripci√≥n de los hechos *</label>
              <textarea id="hechos" placeholder="Describa detalladamente lo sucedido, hora aproximada, veh√≠culos involucrados, etc." required></textarea>
            </div>
            
            <div class="campo">
              <label for="prioridad"><i class="fa-solid fa-exclamation-circle"></i> Prioridad</label>
              <select id="prioridad">
                <option value="Normal">Normal</option>
                <option value="Alta">Alta (riesgo inmediato)</option>
                <option value="Urgente">Urgente (necesita atenci√≥n inmediata)</option>
              </select>
            </div>
            
            <div class="campo" style="display:flex; gap:15px; margin-top: 10px;">
              <button type="button" class="btn-secundario" id="btnVictima">
                <i class="fa-solid fa-user-injured"></i> Datos de la v√≠ctima
              </button>
              <button type="button" class="btn-secundario" id="btnDenunciado">
                <i class="fa-solid fa-user-police"></i> Datos del denunciado
              </button>
            </div>
            
            <div class="campo" style="text-align:center; margin-top: 25px;">
              <button type="submit" class="btn-principal" id="btnEnviar">
                <i class="fa-solid fa-paper-plane"></i> Enviar Denuncia
              </button>
              <p style="font-size: 0.85rem; color: #666; margin-top: 12px;">
                * Campos obligatorios
              </p>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Informaci√≥n adicional -->
      <div class="info-adicional">
        <h3><i class="fa-solid fa-circle-info"></i> Informaci√≥n importante</h3>
        <ul>
          <li>Tu denuncia ser√° revisada por las autoridades correspondientes</li>
          <li>Recibir√°s un n√∫mero de seguimiento para consultar el estado</li>
          <li>Puedes reportar de forma an√≥nima si lo prefieres</li>
          <li>Los datos personales son protegidos seg√∫n la ley de protecci√≥n de datos</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- MODALES MEJORADOS -->
  <div class="modal" id="modalVictima">
    <div class="modal-content">
      <span class="close-modal" id="closeVictima">&times;</span>
      <h3><i class="fa-solid fa-user-injured"></i> Datos de la v√≠ctima (opcional)</h3>
      <input type="text" id="victima_nombre" placeholder="Nombre completo">
      <input type="text" id="victima_dni" placeholder="DNI">
      <input type="text" id="victima_telefono" placeholder="Tel√©fono">
      <button type="button" class="btn-secundario" onclick="document.getElementById('modalVictima').style.display='none'" style="width:100%; margin-top: 10px;">
        Guardar y cerrar
      </button>
    </div>
  </div>

  <div class="modal" id="modalDenunciado">
    <div class="modal-content">
      <span class="close-modal" id="closeDenunciado">&times;</span>
      <h3><i class="fa-solid fa-user-police"></i> Datos del denunciado (opcional)</h3>
      <input type="text" id="denunciado_nombre" placeholder="Nombre completo">
      <input type="text" id="denunciado_dni" placeholder="DNI">
      <input type="text" id="denunciado_telefono" placeholder="Tel√©fono">
      <button type="button" class="btn-secundario" onclick="document.getElementById('modalDenunciado').style.display='none'" style="width:100%; margin-top: 10px;">
        Guardar y cerrar
      </button>
    </div>
  </div>

  <!-- SCRIPTS EN ORDEN CORRECTO -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ESPERAR A QUE TODO EST√â LISTO
    document.addEventListener('DOMContentLoaded', function() {
      // ==================== CONFIGURAR SUPABASE ====================
      const SUPABASE_URL = 'https://grchvnewfkakaqfkgbzy.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_bQZ1guTH9D2ByDwgMYGLfQ_g7bIsktc';
      
      // Verificar que la biblioteca se carg√≥
      if (!window.supabaseLib) {
        mostrarMensaje('Error: Supabase no se carg√≥ correctamente', 'error');
        return;
      }
      
      // Crear cliente de Supabase
      let supabase;
      try {
        supabase = window.supabaseLib.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('‚úÖ Supabase configurado correctamente');
      } catch (error) {
        mostrarMensaje('Error en la configuraci√≥n de la base de datos', 'error');
        console.error('‚ùå Error creando cliente Supabase:', error);
        return;
      }
      
      // ==================== VARIABLES GLOBALES ====================
      let map = null;
      let marcador = null;
      let coordenadasSeleccionadas = null;
      
      // ==================== FUNCI√ìN MOSTRAR MENSAJE ====================
      function mostrarMensaje(mensaje, tipo = 'info') {
        // Eliminar mensaje anterior si existe
        const mensajeAnterior = document.querySelector('.mensaje-flotante');
        if (mensajeAnterior) {
          mensajeAnterior.style.animation = 'slideOut 0.3s ease-out forwards';
          setTimeout(() => mensajeAnterior.remove(), 300);
        }
        
        // Crear nuevo mensaje
        const mensajeDiv = document.createElement('div');
        mensajeDiv.className = `mensaje-flotante ${tipo}`;
        
        // √çconos seg√∫n tipo
        const iconos = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-circle',
          info: 'fa-info-circle',
          warning: 'fa-exclamation-triangle'
        };
        
        mensajeDiv.innerHTML = `
          <i class="fas ${iconos[tipo] || iconos.info}"></i>
          <span>${mensaje}</span>
        `;
        
        document.body.appendChild(mensajeDiv);
        
        // Auto-eliminar despu√©s de 5 segundos
        setTimeout(() => {
          mensajeDiv.style.animation = 'slideOut 0.3s ease-out forwards';
          setTimeout(() => mensajeDiv.remove(), 300);
        }, 5000);
      }
      
      // ==================== INICIALIZAR MAPA ====================
      function inicializarMapa() {
        try {
          map = L.map('mapContainer').setView([-13.5171, -71.9784], 15);
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
          }).addTo(map);
          
          // Icono personalizado para el marcador
          const iconoPersonalizado = L.divIcon({
            className: 'marcador-personalizado',
            html: '<i class="fas fa-map-marker-alt" style="color: #8b0000; font-size: 32px;"></i>',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          });
          
          // Manejar clics en el mapa
          map.on('click', function(e) {
            if (marcador) {
              map.removeLayer(marcador);
            }
            
            coordenadasSeleccionadas = {
              lat: e.latlng.lat,
              lng: e.latlng.lng
            };
            
            marcador = L.marker([coordenadasSeleccionadas.lat, coordenadasSeleccionadas.lng], {
              icon: iconoPersonalizado
            })
              .addTo(map)
              .bindPopup(`
                <div style="font-family: 'Poppins', sans-serif; padding: 5px;">
                  <strong>üìç Ubicaci√≥n seleccionada:</strong><br>
                  ${coordenadasSeleccionadas.lat.toFixed(5)}, ${coordenadasSeleccionadas.lng.toFixed(5)}
                </div>
              `)
              .openPopup();
              
            console.log('üìç Coordenadas:', coordenadasSeleccionadas);
            mostrarMensaje('Ubicaci√≥n seleccionada en el mapa', 'info');
          });
          
          console.log('‚úÖ Mapa inicializado');
        } catch (error) {
          console.error('‚ùå Error inicializando mapa:', error);
          document.getElementById('mapContainer').innerHTML = 
            '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666; font-weight: 600;">Error al cargar el mapa. Verifica tu conexi√≥n.</div>';
        }
      }
      
      // ==================== CONFIGURAR MODALES ====================
      function configurarModales() {
        const modalVictima = document.getElementById("modalVictima");
        const modalDenunciado = document.getElementById("modalDenunciado");
        
        document.getElementById("btnVictima").onclick = () => {
          modalVictima.style.display = "flex";
          document.getElementById('victima_nombre').focus();
        };
        
        document.getElementById("btnDenunciado").onclick = () => {
          modalDenunciado.style.display = "flex";
          document.getElementById('denunciado_nombre').focus();
        };
        
        document.getElementById("closeVictima").onclick = () => modalVictima.style.display = "none";
        document.getElementById("closeDenunciado").onclick = () => modalDenunciado.style.display = "none";
        
        window.onclick = (e) => {
          if (e.target == modalVictima) modalVictima.style.display = "none";
          if (e.target == modalDenunciado) modalDenunciado.style.display = "none";
        };
        
        console.log('‚úÖ Modales configurados');
      }
      
      // ==================== CONFIGURAR FORMULARIO ====================
      function configurarFormulario() {
        const form = document.getElementById('formDenuncia');
        const btnEnviar = document.getElementById('btnEnviar');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validar campos requeridos
          const camposRequeridos = ['tipo_incidente', 'hechos', 'referencia', 'departamento', 'provincia', 'distrito'];
          const camposInvalidos = [];
          
          for (const campoId of camposRequeridos) {
            const campo = document.getElementById(campoId);
            if (!campo.value.trim()) {
              camposInvalidos.push(campo);
              campo.style.borderColor = '#dc3545';
            } else {
              campo.style.borderColor = '#28a745';
            }
          }
          
          if (camposInvalidos.length > 0) {
            mostrarMensaje(`Completa ${camposInvalidos.length} campo(s) obligatorio(s)`, 'warning');
            camposInvalidos[0].focus();
            
            // Quitar borde rojo despu√©s de 3 segundos
            setTimeout(() => {
              camposInvalidos.forEach(campo => {
                campo.style.borderColor = '#e9ecef';
              });
            }, 3000);
            
            return;
          }
          
          // Cambiar estado del bot√≥n
          const textoOriginal = btnEnviar.innerHTML;
          btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
          btnEnviar.disabled = true;
          
          try {
            // Recolectar datos adicionales
            const datosVictima = {
              nombre: document.getElementById('victima_nombre')?.value || '',
              dni: document.getElementById('victima_dni')?.value || '',
              telefono: document.getElementById('victima_telefono')?.value || ''
            };
            
            const datosDenunciado = {
              nombre: document.getElementById('denunciado_nombre')?.value || '',
              dni: document.getElementById('denunciado_dni')?.value || '',
              telefono: document.getElementById('denunciado_telefono')?.value || ''
            };
            
            // Preparar datos para Supabase
            const datosDenuncia = {
              titulo: document.getElementById('tipo_incidente').value,
              descripcion: document.getElementById('hechos').value,
              categoria: 'Tr√°nsito',
              estado: 'pendiente',
              ubicacion: document.getElementById('referencia').value,
              departamento: document.getElementById('departamento').value,
              provincia: document.getElementById('provincia').value,
              distrito: document.getElementById('distrito').value,
              prioridad: document.getElementById('prioridad').value,
              fecha_incidente: document.getElementById('fecha').value,
              coordenadas: coordenadasSeleccionadas ? 
                `${coordenadasSeleccionadas.lat}, ${coordenadasSeleccionadas.lng}` : null,
              creado_en: new Date().toISOString(),
              tipo_formulario: 'denuncia',
              victima_nombre: datosVictima.nombre,
              victima_dni: datosVictima.dni,
              victima_telefono: datosVictima.telefono,
              denunciado_nombre: datosDenunciado.nombre,
              denunciado_dni: datosDenunciado.dni,
              denunciado_telefono: datosDenunciado.telefono,
              usuario_email: 'usuario@example.com', // Cambiar por usuario real
              user_id: null
            };
            
            console.log('üì§ Enviando a Supabase:', datosDenuncia);
            
            // ENVIAR A LA BASE DE DATOS
            const { data, error } = await supabase
              .from('denuncias')
              .insert([datosDenuncia])
              .select();
            
            if (error) {
              throw new Error(`Error de base de datos: ${error.message}`);
            }
            
            // √âXITO
            console.log('‚úÖ Denuncia guardada con ID:', data[0].id);
            
            // Mostrar mensaje de √©xito
            mostrarMensaje(`‚úÖ ¬°Denuncia registrada exitosamente!<br>N√∫mero de seguimiento: CR-${data[0].id}`, 'success');
            
            // Limpiar formulario
            form.reset();
            document.getElementById('fecha').valueAsDate = new Date();
            
            // Limpiar modales
            document.getElementById('victima_nombre').value = '';
            document.getElementById('victima_dni').value = '';
            document.getElementById('victima_telefono').value = '';
            document.getElementById('denunciado_nombre').value = '';
            document.getElementById('denunciado_dni').value = '';
            document.getElementById('denunciado_telefono').value = '';
            
            // Limpiar mapa
            if (marcador) {
              map.removeLayer(marcador);
              marcador = null;
              coordenadasSeleccionadas = null;
            }
            
            // Redirigir despu√©s de 3 segundos
            setTimeout(() => {
              window.location.href = 'consultas.html';
            }, 3000);
            
          } catch (error) {
            console.error('‚ùå Error al enviar:', error);
            mostrarMensaje(`‚ùå Error al registrar la denuncia: ${error.message}`, 'error');
            
          } finally {
            // Restaurar bot√≥n
            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
          }
        });
        
        console.log('‚úÖ Formulario configurado');
      }
      
      // ==================== CONFIGURAR LOGOUT ====================
      document.getElementById("logoutBtn").addEventListener("click", function() {
        if (confirm("¬øEst√°s seguro de cerrar sesi√≥n?")) {
          mostrarMensaje('Cerrando sesi√≥n...', 'info');
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        }
      });
      
      // ==================== INICIALIZAR TODO ====================
      function inicializarTodo() {
        // 1. Poner fecha actual
        const hoy = new Date();
        document.getElementById('fecha').valueAsDate = hoy;
        document.getElementById('fecha').max = hoy.toISOString().split('T')[0]; // No permitir fechas futuras
        
        // 2. Inicializar mapa
        inicializarMapa();
        
        // 3. Configurar modales
        configurarModales();
        
        // 4. Configurar formulario
        configurarFormulario();
        
        console.log('‚úÖ Aplicaci√≥n completamente inicializada');
        mostrarMensaje('Formulario cargado correctamente', 'success');
      }
      
      // EJECUTAR INICIALIZACI√ìN
      inicializarTodo();
      
    }); // Fin del DOMContentLoaded
  </script>
</body>
</html>
