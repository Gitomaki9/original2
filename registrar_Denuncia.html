<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar Denuncia - Cusco Reporta</title>
  
  <!-- RUTAS CORREGIDAS para Netlify (sin ../) -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- CARGAR SUPABASE EN EL HEAD (IMPORTANTE) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Guardar la biblioteca globalmente
    window.supabaseLib = window.supabase;
  </script>
  
  <style>
    #mapContainer { height: 300px; width: 100%; border-radius: 8px; }
    .fila { display: flex; flex-wrap: wrap; gap: 30px; }
    .columna { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    .modal-content h3 { margin-top:0; }
    .close-modal { float:right; cursor:pointer; font-size:18px; font-weight:bold; }
    textarea { width:100%; min-height:100px; padding:8px; border-radius:5px; border:1px solid #ccc; resize:none; }
    
    /* Estilos para mensajes */
    .mensaje-flotante {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .exito { background-color: #28a745; }
    .error { background-color: #dc3545; }
  </style>
</head>
<body>
  <!-- NAVBAR SUPERIOR -->
  <header class="topbar">
    <div class="topbar__logo">
      <img src="assents/images/CuscoReporta.png" alt="Cusco Reporta Logo">
    </div>
    <nav class="topbar__menu">
      <a href="index.html">Inicio</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="ayuda.html">Ayuda</a>
      <a href="consultas.html">Ver Denuncias</a>
    </nav>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container" style="display:flex; gap:20px;">
    <!-- SIDEBAR -->
    <aside class="sidebar" style="display:flex; flex-direction:column; justify-content:flex-start;">
      <div class="sidebar__user" style="margin-bottom:10px;">
        <div class="sidebar__avatar"><i class="fa-solid fa-user"></i></div>
        <div class="sidebar__info"><h3>Jose P√©rez</h3><p>Ciudadano</p></div>
      </div>

      <ul class="sidebar__menu" style="margin-top: 0; padding-top: 0; list-style: none;">
        <li style="display: flex; align-items: flex-start;">
          <a href="perfil_usuario.html">
            <i class="fa-solid fa-id-card" style="width: 20px;"></i>
            <span style="margin-left:8px;">Ver perfil</span>
          </a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="ReportarIncidencia.html">
            <i class="fa-solid fa-pen-to-square" style="width: 20px;"></i>
            <span style="margin-left:8px;">Reportar</span>
          </a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="registrar_Denuncia.html" class="active">
            <i class="fa-solid fa-triangle-exclamation" style="width: 20px;"></i>
            <span style="margin-left:8px;">Denunciar</span>
          </a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="lista_incidencias.html">
            <i class="fa-solid fa-list-check" style="width: 20px;"></i>
            <span style="margin-left:8px;">Estado de reportes</span>
          </a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="MapaIncidiencias(Ciudadano).html">
            <i class="fa-solid fa-map-location-dot" style="width: 20px;"></i>
            <span style="margin-left:8px;">Mapa de incidencias</span>
          </a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="notificaciones.html">
            <i class="fa-solid fa-bell" style="width: 20px;"></i>
            <span style="margin-left:8px;">Notificaciones</span>
          </a>
        </li>
      </ul>

      <button class="logout-btn" id="logoutBtn" style="margin-top:auto;">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n
      </button>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content denuncia-form" style="flex:1;">
      <h1><i class="fa-solid fa-triangle-exclamation"></i> Registrar Denuncia</h1>
      <p style="color: #666; margin-bottom: 25px;">Completa el formulario para reportar una incidencia de tr√°nsito.</p>
      
      <form id="formDenuncia" class="formulario">
        <div class="fila">
          <!-- IZQUIERDA -->
          <div class="columna">
            <div class="campo">
              <label for="fecha"><i class="fa-solid fa-calendar"></i> Fecha *</label>
              <input type="date" id="fecha" required>
            </div>
            
            <div class="campo">
              <label for="departamento"><i class="fa-solid fa-location-dot"></i> Departamento *</label>
              <select id="departamento" required>
                <option value="">Seleccione</option>
                <option value="Cusco" selected>Cusco</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="provincia">Provincia *</label>
              <select id="provincia" required>
                <option value="">Seleccione</option>
                <option value="Cusco" selected>Cusco</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="distrito">Distrito *</label>
              <select id="distrito" required>
                <option value="">Seleccione</option>
                <option value="Cusco">Cusco</option>
                <option value="San Sebasti√°n">San Sebasti√°n</option>
                <option value="San Jer√≥nimo">San Jer√≥nimo</option>
              </select>
            </div>
            
            <div class="campo">
              <label for="referencia"><i class="fa-solid fa-map-pin"></i> Referencia *</label>
              <input type="text" id="referencia" placeholder="Ej: Av. El Sol frente al mercado" required>
            </div>

            <!-- Tipo de incidente -->
            <div class="campo">
              <label for="tipo_incidente"><i class="fa-solid fa-car-burst"></i> Tipo de incidente *</label>
              <select id="tipo_incidente" required>
                <option value="">Seleccione</option>
                <option value="Accidente">Accidente</option>
                <option value="Choque">Choque</option>
                <option value="Mal estacionamiento">Mal estacionamiento</option>
                <option value="Robo">Robo</option>
                <option value="Exceso de velocidad">Exceso de velocidad</option>
                <option value="Bache o hueco">Bache o hueco</option>
                <option value="Sem√°foro da√±ado">Sem√°foro da√±ado</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>

          <!-- DERECHA: DATOS Y MAPA -->
          <div class="columna">
            <div class="campo">
              <label><i class="fa-solid fa-map"></i> Ubicar en el mapa (opcional)</label>
              <div id="mapContainer"></div>
              <p style="font-size: 12px; color: #666; margin-top: 5px;">
                Haz clic en el mapa para seleccionar la ubicaci√≥n exacta
              </p>
            </div>
            
            <!-- Descripci√≥n de los hechos -->
            <div class="campo">
              <label for="hechos"><i class="fa-solid fa-file-lines"></i> Descripci√≥n de los hechos *</label>
              <textarea id="hechos" placeholder="Describa detalladamente lo sucedido, hora aproximada, veh√≠culos involucrados, etc." required></textarea>
            </div>
            
            <div class="campo">
              <label for="prioridad"><i class="fa-solid fa-exclamation-circle"></i> Prioridad</label>
              <select id="prioridad">
                <option value="Normal">Normal</option>
                <option value="Alta">Alta (riesgo inmediato)</option>
                <option value="Urgente">Urgente (necesita atenci√≥n inmediata)</option>
              </select>
            </div>
            
            <div class="campo" style="display:flex; gap:10px; margin-top: 10px;">
              <button type="button" class="btn-secundario" id="btnVictima" style="flex:1;">
                <i class="fa-solid fa-user-injured"></i> Datos de la v√≠ctima
              </button>
              <button type="button" class="btn-secundario" id="btnDenunciado" style="flex:1;">
                <i class="fa-solid fa-user-police"></i> Datos del denunciado
              </button>
            </div>
            
            <div class="campo" style="text-align:center; margin-top: 20px;">
              <button type="submit" class="btn-principal" id="btnEnviar" style="padding: 12px 30px; font-size: 16px;">
                <i class="fa-solid fa-paper-plane"></i> Enviar Denuncia
              </button>
              <p style="font-size: 12px; color: #666; margin-top: 10px;">
                * Campos obligatorios
              </p>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Informaci√≥n adicional -->
      <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h3><i class="fa-solid fa-circle-info"></i> Informaci√≥n importante</h3>
        <ul style="color: #555;">
          <li>Tu denuncia ser√° revisada por las autoridades correspondientes</li>
          <li>Recibir√°s un n√∫mero de seguimiento para consultar el estado</li>
          <li>Puedes reportar de forma an√≥nima si lo prefieres</li>
          <li>Los datos personales son protegidos seg√∫n la ley de protecci√≥n de datos</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- MODALES -->
  <div class="modal" id="modalVictima">
    <div class="modal-content">
      <span class="close-modal" id="closeVictima">&times;</span>
      <h3><i class="fa-solid fa-user-injured"></i> Datos de la v√≠ctima (opcional)</h3>
      <input type="text" id="victima_nombre" placeholder="Nombre completo"><br><br>
      <input type="text" id="victima_dni" placeholder="DNI"><br><br>
      <input type="text" id="victima_telefono" placeholder="Tel√©fono"><br><br>
      <button type="button" class="btn-secundario" onclick="document.getElementById('modalVictima').style.display='none'" style="width:100%;">Guardar y cerrar</button>
    </div>
  </div>

  <div class="modal" id="modalDenunciado">
    <div class="modal-content">
      <span class="close-modal" id="closeDenunciado">&times;</span>
      <h3><i class="fa-solid fa-user-police"></i> Datos del denunciado (opcional)</h3>
      <input type="text" id="denunciado_nombre" placeholder="Nombre completo"><br><br>
      <input type="text" id="denunciado_dni" placeholder="DNI"><br><br>
      <input type="text" id="denunciado_telefono" placeholder="Tel√©fono"><br><br>
      <button type="button" class="btn-secundario" onclick="document.getElementById('modalDenunciado').style.display='none'" style="width:100%;">Guardar y cerrar</button>
    </div>
  </div>

  <!-- SCRIPTS EN ORDEN CORRECTO -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ESPERAR A QUE TODO EST√â LISTO
    document.addEventListener('DOMContentLoaded', function() {
      // ==================== CONFIGURAR SUPABASE ====================
      // ¬°REEMPLAZA CON TUS CREDENCIALES EXACTAS!
      const SUPABASE_URL = 'https://grchvnewfkakaqfkgbzy.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_bQZ1guTH9D2ByDwgMYGLfQ_g7bIsktc';
      
      // Verificar que la biblioteca se carg√≥
      if (!window.supabaseLib) {
        console.error('‚ùå Error: Supabase no se carg√≥ correctamente');
        alert('Error: No se pudo conectar con la base de datos. Recarga la p√°gina.');
        return;
      }
      
      // Crear cliente de Supabase
      let supabase;
      try {
        supabase = window.supabaseLib.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('‚úÖ Supabase configurado correctamente');
      } catch (error) {
        console.error('‚ùå Error creando cliente Supabase:', error);
        alert('Error en la configuraci√≥n de la base de datos.');
        return;
      }
      
      // ==================== VARIABLES GLOBALES ====================
      let map = null;
      let marcador = null;
      let coordenadasSeleccionadas = null;
      
      // ==================== INICIALIZAR MAPA ====================
      function inicializarMapa() {
        try {
          map = L.map('mapContainer').setView([-13.5171, -71.9784], 15);
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
          }).addTo(map);
          
          // Manejar clics en el mapa
          map.on('click', function(e) {
            if (marcador) {
              map.removeLayer(marcador);
            }
            
            coordenadasSeleccionadas = {
              lat: e.latlng.lat,
              lng: e.latlng.lng
            };
            
            marcador = L.marker([coordenadasSeleccionadas.lat, coordenadasSeleccionadas.lng])
              .addTo(map)
              .bindPopup(`Ubicaci√≥n: ${coordenadasSeleccionadas.lat.toFixed(5)}, ${coordenadasSeleccionadas.lng.toFixed(5)}`)
              .openPopup();
              
            console.log('üìç Coordenadas:', coordenadasSeleccionadas);
          });
          
          console.log('‚úÖ Mapa inicializado');
        } catch (error) {
          console.error('‚ùå Error inicializando mapa:', error);
          document.getElementById('mapContainer').innerHTML = 
            '<p style="color:red; padding:20px;">Error al cargar el mapa. Verifica tu conexi√≥n.</p>';
        }
      }
      
      // ==================== CONFIGURAR MODALES ====================
      function configurarModales() {
        const modalVictima = document.getElementById("modalVictima");
        const modalDenunciado = document.getElementById("modalDenunciado");
        
        document.getElementById("btnVictima").onclick = () => modalVictima.style.display = "flex";
        document.getElementById("btnDenunciado").onclick = () => modalDenunciado.style.display = "flex";
        
        document.getElementById("closeVictima").onclick = () => modalVictima.style.display = "none";
        document.getElementById("closeDenunciado").onclick = () => modalDenunciado.style.display = "none";
        
        window.onclick = (e) => {
          if (e.target == modalVictima) modalVictima.style.display = "none";
          if (e.target == modalDenunciado) modalDenunciado.style.display = "none";
        };
        
        console.log('‚úÖ Modales configurados');
      }
      
      // ==================== CONFIGURAR FORMULARIO ====================
      function configurarFormulario() {
        const form = document.getElementById('formDenuncia');
        const btnEnviar = document.getElementById('btnEnviar');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validar campos requeridos
          const camposRequeridos = ['tipo_incidente', 'hechos', 'referencia', 'departamento', 'provincia', 'distrito'];
          for (const campoId of camposRequeridos) {
            const campo = document.getElementById(campoId);
            if (!campo.value.trim()) {
              alert(`Por favor completa el campo: ${campo.previousElementSibling.textContent}`);
              campo.focus();
              return;
            }
          }
          
          // Cambiar estado del bot√≥n
          const textoOriginal = btnEnviar.innerHTML;
          btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
          btnEnviar.disabled = true;
          
          try {
            // Preparar datos para Supabase
            const datosDenuncia = {
              titulo: document.getElementById('tipo_incidente').value,
              descripcion: document.getElementById('hechos').value,
              categoria: 'Tr√°nsito',
              estado: 'pendiente',
              ubicacion: document.getElementById('referencia').value,
              departamento: document.getElementById('departamento').value,
              provincia: document.getElementById('provincia').value,
              distrito: document.getElementById('distrito').value,
              prioridad: document.getElementById('prioridad').value,
              fecha_incidente: document.getElementById('fecha').value,
              coordenadas: coordenadasSeleccionadas ? 
                `${coordenadasSeleccionadas.lat}, ${coordenadasSeleccionadas.lng}` : null,
              creado_en: new Date().toISOString()
            };
            
            console.log('üì§ Enviando a Supabase:', datosDenuncia);
            
            // ENVIAR A LA BASE DE DATOS
            const { data, error } = await supabase
              .from('denuncias')
              .insert([datosDenuncia])
              .select();
            
            if (error) {
              throw new Error(`Error de base de datos: ${error.message}`);
            }
            
            // √âXITO
            console.log('‚úÖ Denuncia guardada con ID:', data[0].id);
            
            // Mostrar mensaje de √©xito
            alert(`‚úÖ ¬°Denuncia registrada exitosamente!\n\nN√∫mero de seguimiento: CR-${data[0].id}\nPuedes ver el estado en la p√°gina de consultas.`);
            
            // Limpiar formulario
            form.reset();
            document.getElementById('fecha').valueAsDate = new Date();
            
            // Limpiar mapa
            if (marcador) {
              map.removeLayer(marcador);
              marcador = null;
              coordenadasSeleccionadas = null;
            }
            
            // Redirigir despu√©s de 2 segundos
            setTimeout(() => {
              window.location.href = 'consultas.html';
            }, 2000);
            
          } catch (error) {
            console.error('‚ùå Error al enviar:', error);
            alert(`‚ùå Error al registrar la denuncia:\n${error.message}`);
            
            // Restaurar bot√≥n
            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
          }
        });
        
        console.log('‚úÖ Formulario configurado');
      }
      
      // ==================== CONFIGURAR LOGOUT ====================
      document.getElementById("logoutBtn").addEventListener("click", function() {
        if (confirm("¬øEst√°s seguro de cerrar sesi√≥n?")) {
          window.location.href = "index.html";
        }
      });
      
      // ==================== INICIALIZAR TODO ====================
      function inicializarTodo() {
        // 1. Poner fecha actual
        document.getElementById('fecha').valueAsDate = new Date();
        
        // 2. Inicializar mapa
        inicializarMapa();
        
        // 3. Configurar modales
        configurarModales();
        
        // 4. Configurar formulario
        configurarFormulario();
        
        console.log('‚úÖ Aplicaci√≥n completamente inicializada');
      }
      
      // EJECUTAR INICIALIZACI√ìN
      inicializarTodo();
      
    }); // Fin del DOMContentLoaded
  </script>
</body>
</html>
