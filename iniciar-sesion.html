<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar Sesi√≥n - Cusco Reporta</title>

  <!-- ESTILOS -->
  <link rel="stylesheet" href="../css/styles.css" />
  <!-- FontAwesome para √≠conos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Fuente Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Poppins", sans-serif; }
    .page-wrap{
      min-height: calc(100vh - 80px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 40px 16px;
      background: radial-gradient(circle at top, #7b0000 0%, #3b0000 60%, #1c0000 100%);
    }
    .auth-card{
      width: min(920px, 96vw);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: 26px 22px 22px;
    }
    .auth-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      text-align:center;
      margin-bottom: 18px;
    }
    .auth-header img{
      height: 48px;
      object-fit: contain;
    }
    .auth-header h1{
      margin: 0;
      color: #8b0000;
      font-size: 1.55rem;
      letter-spacing: .5px;
    }
    .auth-header p{
      margin: 0;
      color:#555;
      font-size: .95rem;
    }

    .toggle-row{
      display:flex;
      justify-content:center;
      margin: 18px 0 22px;
    }
    .toggle{
      display:flex;
      border-radius: 999px;
      overflow:hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .toggle a{
      padding: 10px 18px;
      text-decoration:none;
      font-weight: 700;
      color:#fff;
      display:flex;
      align-items:center;
      gap:8px;
      background:#c43d3d;
      opacity:.9;
    }
    .toggle a.active{
      background:#8b0000;
      opacity: 1;
    }

    .form{
      width: min(420px, 100%);
      margin: 0 auto;
    }
    .form-group{ margin-bottom: 16px; }
    .form-label{
      display:block;
      font-weight: 700;
      margin-bottom: 8px;
      color:#333;
    }
    .form-input{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      outline: none;
      font-weight: 600;
    }
    .form-input:focus{
      border-color:#8b0000;
      background:#fff;
    }
    .submit-btn{
      width:100%;
      border:none;
      background:#8b0000;
      color:#fff;
      padding: 12px 16px;
      border-radius: 14px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .05s ease;
    }
    .submit-btn:active{ transform: scale(.99); }

    .links{
      display:flex;
      justify-content:center;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .links a{
      color:#8b0000;
      text-decoration:none;
      font-weight:700;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .footer-msg{
      text-align:center;
      margin-top: 18px;
      color:#666;
      font-weight: 700;
      letter-spacing: .5px;
    }

    /* CREDENCIALES DE PRUEBA */
    .credenciales-prueba {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 4px solid #8b0000;
    }
    .credenciales-prueba h4 {
      margin-top: 0;
      color: #8b0000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .credenciales-prueba p {
      margin: 8px 0;
      font-size: 0.9rem;
    }

    /* NOTIFICACIONES */
    .auth-notificacion {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      animation: slideInAuth 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 400px;
    }
    @keyframes slideInAuth {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutAuth {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .auth-notificacion.success { background: #28a745; }
    .auth-notificacion.error { background: #dc3545; }
    .auth-notificacion.info { background: #17a2b8; }

    .auth-loading {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 600px){
      .auth-card{ padding: 20px 16px 18px; }
    }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="navbar__left" style="display:flex; align-items:center; gap:10px;">
      <img src="../assents/images/CuscoReporta.png" alt="Logo Cusco Reporta" class="navbar__logo">
    </div>

    <nav class="navbar__menu">
      <a href="index.html">Inicio</a>
      <a href="registrar_tu_denuncia.html">Registra tu denuncia</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="iniciar-sesion.html" class="active">Iniciar Sesi√≥n</a>
      <a href="ayuda.html">Ayuda</a>
    </nav>
  </header>

  <main class="page-wrap">
    <section class="auth-card">
      <div class="auth-header">
        <img src="../assents/images/CuscoReporta.png" alt="Cusco Reporta">
        <h1>INICIO DE SESI√ìN</husuario@cuscoreporta.com1>
        <p>Usa las credenciales de prueba o tu cuenta registrada</p>
        
        <!-- CREDENCIALES DE PRUEBA -->
        <div class="credenciales-prueba">
          <h4><i class="fas fa-key"></i> Credenciales de Prueba</h4>
          <p><strong>Email:</strong> test@cuscoreporta.com</p>
          <p><strong>Contrase√±a:</strong> Test123456</p>
          <p style="font-size: 0.8rem; color: #666;">
            <i class="fas fa-info-circle"></i> Si no funciona, crea tu propia cuenta
          </p>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle">
          <a href="iniciar-sesion.html" class="active">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
          </a>
          <a href="Registro_Usuario.html">
            <i class="fas fa-user-plus"></i> Registrarse
          </a>
        </div>
      </div>

      <form id="formLogin" class="form">
        <div class="form-group">
          <label for="email" class="form-label">
            <i class="fas fa-envelope"></i> Correo Electr√≥nico
          </label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-input"
            placeholder="tu@email.com"
            required
            value="test@cuscoreporta.com"
          />
        </div>

        <div class="form-group">
          <label for="password" class="form-label">
            <i class="fas fa-lock"></i> Contrase√±a
          </label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            required
            value="Test123456"
          />
        </div>

        <button type="submit" class="submit-btn" id="btnLogin">
          <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
        </button>

        <div class="links">
          <a href="recuperar_contrasena.html">
            <i class="fas fa-key"></i> ¬øOlvidaste tu contrase√±a?
          </a>
          <a href="Registro_Usuario.html">
            <i class="fas fa-user-plus"></i> Crear cuenta nueva
          </a>
          <a href="index.html">
            <i class="fas fa-home"></i> ‚Üê Volver al inicio
          </a>
        </div>
      </form>

      <!-- BOT√ìN PARA CREAR USUARIOS DE PRUEBA (SOLO DESARROLLO) -->
      <div style="text-align: center; margin-top: 20px;">
        <button id="btnCrearUsuarios" 
                style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
          <i class="fas fa-magic"></i> Crear Usuarios de Prueba
        </button>
        <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
          (Solo para desarrollo - crea 3 usuarios autom√°ticamente)
        </p>
      </div>

      <div class="footer-msg">¬°CONF√çA EN NOSOTROS!</div>
    </section>
  </main>

  <!-- SCRIPTS EN ORDEN CORRECTO -->
  <!-- 1. Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- 2. Auth.js SIMPLIFICADO (lo creamos inline primero) -->
  <script>
    // ==================== AUTH.JS SIMPLIFICADO ====================
    
    // CONFIGURACI√ìN (¬°REEMPLAZA CON TUS CREDENCIALES!)
    const SUPABASE_URL = 'https://grchvnewfkakaqfkgbzy.supabase.co';
    // ‚ö†Ô∏è REEMPLAZA ESTO con tu ANON KEY de Supabase
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...TU_CLAVE_AQUI';
    
    // Crear cliente
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // FUNCIONES DE AUTH
    window.supabaseAuth = {
      // 1. INICIAR SESI√ìN
      async iniciarSesion(email, password) {
        try {
          console.log('üîê Intentando login:', email);
          
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
          });
          
          if (error) {
            console.error('‚ùå Error login:', error);
            throw error;
          }
          
          console.log('‚úÖ Login exitoso:', data.user.email);
          
          // Guardar en sessionStorage
          sessionStorage.setItem('auth_user', JSON.stringify(data.user));
          sessionStorage.setItem('auth_token', data.session.access_token);
          
          return {
            success: true,
            user: data.user,
            session: data.session
          };
          
        } catch (error) {
          return {
            success: false,
            error: error.message
          };
        }
      },
      
      // 2. MOSTRAR NOTIFICACI√ìN
      mostrarNotificacion(mensaje, tipo = 'info') {
        // Eliminar notificaci√≥n anterior si existe
        const notifAnterior = document.querySelector('.auth-notificacion');
        if (notifAnterior) {
          notifAnterior.style.animation = 'slideOutAuth 0.3s ease-out forwards';
          setTimeout(() => notifAnterior.remove(), 300);
        }
        
        // Crear nueva notificaci√≥n
        const notificacion = document.createElement('div');
        notificacion.className = `auth-notificacion ${tipo}`;
        
        const iconos = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-circle',
          info: 'fa-info-circle'
        };
        
        notificacion.innerHTML = `
          <i class="fas ${iconos[tipo] || 'fa-info-circle'}"></i>
          <span>${mensaje}</span>
        `;
        
        document.body.appendChild(notificacion);
        
        // Auto-eliminar despu√©s de 4 segundos
        setTimeout(() => {
          notificacion.style.animation = 'slideOutAuth 0.3s ease-out forwards';
          setTimeout(() => notificacion.remove(), 300);
        }, 4000);
      },
      
      // 3. OBTENER USUARIO ACTUAL
      obtenerUsuarioActual() {
        try {
          const userStr = sessionStorage.getItem('auth_user');
          return userStr ? JSON.parse(userStr) : null;
        } catch {
          return null;
        }
      },
      
      // 4. CREAR USUARIOS DE PRUEBA
      async crearUsuariosPrueba() {
        const usuarios = [
          { email: 'test@cuscoreporta.com', password: 'Test123456', nombre: 'Usuario Test' },
          { email: 'policia@cuscoreporta.com', password: 'Policia123', nombre: 'Oficial de Tr√°nsito' },
          { email: 'admin@cuscoreporta.com', password: 'Admin123456', nombre: 'Administrador' }
        ];
        
        let resultados = 'Resultados:\n\n';
        
        for (const usuario of usuarios) {
          try {
            const { error } = await supabase.auth.signUp({
              email: usuario.email,
              password: usuario.password,
              options: {
                data: {
                  nombre_completo: usuario.nombre,
                  tipo_usuario: usuario.email.includes('admin') ? 'administrador' : 
                               usuario.email.includes('policia') ? 'policia' : 'ciudadano'
                }
              }
            });
            
            if (error) {
              if (error.message.includes('already registered')) {
                resultados += `‚úÖ ${usuario.email}: Ya existe (puedes usarlo)\n`;
              } else {
                resultados += `‚ùå ${usuario.email}: ${error.message}\n`;
              }
            } else {
              resultados += `‚úÖ ${usuario.email}: Creado exitosamente\n`;
            }
            
          } catch (err) {
            resultados += `‚ùå ${usuario.email}: ${err.message}\n`;
          }
        }
        
        alert(resultados + '\n\nCredenciales:\n' +
              '1. test@cuscoreporta.com / Test123456\n' +
              '2. policia@cuscoreporta.com / Policia123\n' +
              '3. admin@cuscoreporta.com / Admin123456');
      }
    };
    
    console.log('‚úÖ Supabase Auth configurado');
  </script>
  
  <!-- 3. Manejo del formulario -->
  <script>
    // Manejar el formulario de login
    document.getElementById('formLogin').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const btnLogin = document.getElementById('btnLogin');
      
      // Validaci√≥n b√°sica
      if (!email || !password) {
        window.supabaseAuth.mostrarNotificacion('Por favor completa todos los campos', 'error');
        return;
      }
      
      // Cambiar estado del bot√≥n
      const originalHTML = btnLogin.innerHTML;
      btnLogin.innerHTML = '<i class="fas fa-spinner auth-loading"></i> Iniciando sesi√≥n...';
      btnLogin.disabled = true;
      
      try {
        // Usar Supabase Auth
        const resultado = await window.supabaseAuth.iniciarSesion(email, password);
        
        if (resultado.success) {
          window.supabaseAuth.mostrarNotificacion(
            `¬°Bienvenido ${resultado.user.email}!`, 
            'success'
          );
          
          // Redirigir despu√©s de 1.5 segundos
        setTimeout(() => {
          // Obtener tipo de usuario de los metadata
          const user = window.supabaseAuth.obtenerUsuarioActual();
          const tipo = user?.user_metadata?.tipo_usuario || 'ciudadano';
          
          if (tipo === 'administrador') {
            window.location.href = 'perfil_admin.html';
          } else if (tipo === 'policia') {
            window.location.href = 'policia/dashboard.html';
          } else {
            window.location.href = 'perfil_usuario.html'; // ‚Üê CAMBIA AQU√ç
          }
        }, 1500);
          
        } else {
          // Manejar errores espec√≠ficos
          let mensajeError = resultado.error;
          
          if (resultado.error.includes('Invalid login credentials')) {
            mensajeError = 'Email o contrase√±a incorrectos';
          } else if (resultado.error.includes('Email not confirmed')) {
            mensajeError = 'Por favor verifica tu email antes de iniciar sesi√≥n';
          }
          
          throw new Error(mensajeError);
        }
        
      } catch (error) {
        window.supabaseAuth.mostrarNotificacion(
          `Error: ${error.message}`, 
          'error'
        );
        
      } finally {
        // Restaurar bot√≥n
        btnLogin.innerHTML = originalHTML;
        btnLogin.disabled = false;
      }
    });
    
    // Bot√≥n para crear usuarios de prueba
    <!-- En tu iniciar-sesion.html, MODIFICA el script del final -->

<script>
  // Manejar el formulario de login
  document.getElementById('formLogin').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const btnLogin = document.getElementById('btnLogin');
    
    // Validaci√≥n b√°sica
    if (!email || !password) {
      mostrarAlertaSimple('Por favor completa todos los campos', 'error');
      return;
    }
    
    // Cambiar estado del bot√≥n
    const originalHTML = btnLogin.innerHTML;
    btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';
    btnLogin.disabled = true;
    
    try {
      // Usar Supabase Auth
      const resultado = await window.supabaseAuth.iniciarSesion(email, password);
      
      if (resultado.success) {
        mostrarAlertaSimple(`¬°Bienvenido ${resultado.user.email}!`, 'success');
        
        // Redirigir seg√∫n tipo de usuario
        setTimeout(() => {
          const tipo = resultado.user.tipo_usuario || 'ciudadano';
          
          if (tipo === 'administrador') {
            window.location.href = 'admin/dashboard.html';
          } else if (tipo === 'policia') {
            window.location.href = 'policia/dashboard.html';
          } else {
            window.location.href = 'perfil_usuario.html'; // ‚Üê AQU√ç REDIRIGE
          }
        }, 1500);
        
      } else {
        throw new Error(resultado.error);
      }
      
    } catch (error) {
      // Manejar errores espec√≠ficos
      let mensaje = error.message;
      
      if (error.message.includes('Invalid login credentials')) {
        mensaje = 'Email o contrase√±a incorrectos';
      } else if (error.message.includes('Email not confirmed')) {
        mensaje = 'Por favor verifica tu email antes de iniciar sesi√≥n';
      }
      
      mostrarAlertaSimple(`Error: ${mensaje}`, 'error');
      
    } finally {
      // Restaurar bot√≥n
      btnLogin.innerHTML = originalHTML;
      btnLogin.disabled = false;
    }
  });
  
  // Funci√≥n simple para alertas (temporal)
  function mostrarAlertaSimple(mensaje, tipo = 'info') {
    alert(tipo === 'error' ? '‚ùå ' + mensaje : '‚úÖ ' + mensaje);
  }
</script>
</body>
</html>


